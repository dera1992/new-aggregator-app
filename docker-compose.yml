version: "3.9"

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgresql://user:password@db:5432/news_db
      SECRET_KEY: change-me
      RUN_DB_INIT: "true"
      RUN_BACKGROUND_JOBS: "false"   # IMPORTANT: app should not run jobs
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - db
      - redis

  worker:
    build: .
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      DATABASE_URL: postgresql://user:password@db:5432/news_db
      SECRET_KEY: change-me
      RUN_DB_INIT: "false"
      RUN_BACKGROUND_JOBS: "true"
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - db
      - redis
    command: ["sh", "-c", "/entrypoint.sh python run_jobs.py"]

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: news_db
    volumes:
      - db-data:/var/lib/postgresql/data

  pgadmin:
    image: dpage/pgadmin4:9.8
    ports:
      - 5050:80
    environment:
      # Required by pgAdmin
      PGADMIN_DEFAULT_EMAIL: demo@example.com
      PGADMIN_DEFAULT_PASSWORD: secret
      # Don't require the user to login
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      # Don't require a "master" password after logging in
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'

  redis:
    image: redis:7-alpine

volumes:
  db-data:
